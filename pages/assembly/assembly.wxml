<!-- pages/assembly/assembly.wxml -->
<view class="container">
  <!-- ç»„è£…è¡¨å• -->
  <view class="form-section">
    <view class="section-header">
      <text class="section-icon">ğŸ”§</text>
      <text class="section-title">äº§å“è£…é…</text>
    </view>

    <!-- è£…é…äº§å“ï¼ˆä¸‹æ‹‰ï¼‰ -->
    <view class="form-item">
      <text class="label">è£…é…äº§å“</text>
      <picker bindchange="onProductChange" value="{{productIndex}}" range="{{productNames}}">
        <view class="picker">{{formData.productName || 'è¯·é€‰æ‹©è£…é…äº§å“'}}</view>
      </picker>
    </view>

    <!-- è§„æ ¼ï¼ˆä¸‹æ‹‰ï¼‰ -->
    <view class="form-item">
      <text class="label">è§„æ ¼</text>
      <picker bindchange="onSpecChange" value="{{specIndex}}" range="{{specOptions}}">
        <view class="picker">{{formData.specification || 'è¯·é€‰æ‹©è§„æ ¼'}}</view>
      </picker>
    </view>

    <!-- ææ–™ -->
    <view class="form-item">
      <text class="label">ææ–™</text>
      <picker bindchange="onMaterialChange" value="{{materialIndex}}" range="{{materials}}">
        <view class="picker">{{formData.material || 'è¯·é€‰æ‹©ææ–™'}}</view>
      </picker>
    </view>

    <!-- è¿æ¥ç±»å‹ -->
    <view class="form-item">
      <text class="label">è¿æ¥ç±»å‹</text>
      <picker bindchange="onConnectionTypeChange" value="{{connectionTypeIndex}}" range="{{connectionTypes}}">
        <view class="picker">{{formData.connectionType || 'è¯·é€‰æ‹©è¿æ¥ç±»å‹'}}</view>
      </picker>
    </view>

    <!-- æ•°é‡ï¼ˆå¸¦+/-æŒ‰é’®ï¼‰ -->
    <view class="form-item">
      <text class="label">æ•°é‡</text>
      <view class="qty-control">
        <view class="qty-btn {{formData.quantity <= 1 ? 'disabled' : ''}}" bindtap="decreaseQty">âˆ’</view>
        <input class="qty-input" type="number" value="{{formData.quantity}}" bindinput="onQuantityInput" />
        <view class="qty-btn" bindtap="increaseQty">+</view>
      </view>
    </view>
  </view>

  <!-- æ‰€éœ€é›¶ä»¶è¡¨æ ¼ -->
  <view class="parts-section" wx:if="{{requiredParts.length > 0}}">
    <view class="parts-header">
      <text class="parts-title">æ‰€éœ€é›¶ä»¶ï¼š</text>
      <text class="parts-hint">ğŸ“‹ è¡¨æ ¼å¯å·¦å³æ»‘åŠ¨</text>
    </view>
    <scroll-view scroll-x class="parts-table-wrapper">
      <view class="parts-table">
        <view class="table-row table-header">
          <view class="table-cell cell-name">é›¶ä»¶åç§°</view>
          <view class="table-cell cell-unit">å•ä»¶éœ€è¦</view>
          <view class="table-cell cell-need">è£…é…éœ€è¦</view>
          <view class="table-cell cell-stock">åº“å­˜</view>
        </view>
        <view class="table-row" wx:for="{{inventoryStatus.length > 0 ? inventoryStatus : requiredParts}}" wx:key="componentName">
          <view class="table-cell cell-name">{{item.componentName}}</view>
          <view class="table-cell cell-unit">{{item.unitQty || item.quantity || 1}}</view>
          <view class="table-cell cell-need">{{item.needed || (item.quantity || 1) * formData.quantity}}</view>
          <view class="table-cell cell-stock {{item.isEnough === false ? 'insufficient' : ''}}">
            {{item.available !== undefined ? item.available : '-'}}
          </view>
        </view>
      </view>
    </scroll-view>

    <!-- åº“å­˜çŠ¶æ€æç¤º -->
    <view class="inventory-status" wx:if="{{inventoryStatus.length > 0}}">
      <view class="status-ok" wx:if="{{canAssemble}}">
        <text class="status-icon">âœ…</text>
        <text>åº“å­˜å……è¶³ï¼Œå¯ä»¥è£…é…</text>
      </view>
      <view class="status-error" wx:else>
        <text class="status-icon">âš ï¸</text>
        <text>åº“å­˜ä¸è¶³ï¼Œæ— æ³•è£…é…</text>
      </view>
    </view>
  </view>

  <!-- å¤‡æ³¨ -->
  <view class="form-section remark-section">
    <view class="form-item">
      <text class="label">å¤‡æ³¨</text>
      <textarea class="textarea" placeholder="å¤‡æ³¨ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰" value="{{formData.remarks}}" bindinput="onRemarksInput"></textarea>
    </view>
  </view>

  <button class="submit-btn {{!canAssemble && insufficientParts.length > 0 ? 'btn-warning' : ''}}"
    bindtap="submitForm" disabled="{{submitting}}">
    {{submitting ? 'æäº¤ä¸­...' : 'æ‰§è¡Œè£…é…'}}
  </button>

  <!-- ç»„è£…è®°å½•åˆ—è¡¨ -->
  <view class="records-section">
    <view class="section-title">ç»„è£…è®°å½•</view>
    <scroll-view scroll-y class="records-list" wx:if="{{records.length > 0}}">
      <view class="record-item" wx:for="{{records}}" wx:key="id">
        <view class="record-main">
          <text class="record-name">{{item.productName}}</text>
          <view class="record-specs">
            <text class="spec-tag">{{item.specification}}</text>
            <text class="spec-tag">{{item.material}}</text>
          </view>
        </view>
        <view class="record-right">
          <text class="record-qty">Ã—{{item.quantity}}</text>
          <text class="record-time">{{item.createdAtStr}}</text>
        </view>
      </view>
    </scroll-view>
    <view class="empty-state" wx:else>
      <text>æš‚æ— ç»„è£…è®°å½•</text>
    </view>
  </view>
</view>

