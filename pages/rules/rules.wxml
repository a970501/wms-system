<!-- pages/rules/rules.wxml -->
<view class="container">
  <!-- æ ‡ç­¾é¡µ -->
  <view class="tabs">
    <view class="tab {{ruleType === 'storage' ? 'active' : ''}}" bindtap="switchTab" data-type="storage">å…¥åº“è§„åˆ™</view>
    <view class="tab {{ruleType === 'assembly' ? 'active' : ''}}" bindtap="switchTab" data-type="assembly">è£…é…è§„åˆ™</view>
  </view>

  <!-- è§„åˆ™åˆ—è¡¨ -->
  <scroll-view scroll-y class="rules-list">
    <view class="rule-item" wx:for="{{rules}}" wx:key="id" bindtap="editRule" data-rule="{{item}}">
      <view class="rule-header">
        <text class="rule-name">{{item.ruleName || item.productName}}</text>
        <switch class="rule-switch" checked="{{item.isEnabled}}" catchtap="toggleRule" data-id="{{item.id}}" />
      </view>
      <view class="rule-info" wx:if="{{ruleType === 'storage'}}">
        <text class="info-tag">åŒ¹é…: {{item.productPattern}}</text>
        <text class="info-tag">ç›®æ ‡: {{item.targetLocation}}</text>
        <text class="info-tag" wx:if="{{item.storageRatio}}">æ¯”ä¾‹: {{item.storageRatio}}</text>
        <text class="info-tag" wx:if="{{item.blankProductName}}">æ¯›å¯: {{item.blankProductName}} Ã—{{item.blankQuantityPerUnit}}</text>
      </view>
      <view class="rule-info" wx:if="{{ruleType === 'assembly'}}">
        <text class="info-tag">äº§å“: {{item.productName}}</text>
        <text class="info-tag" wx:if="{{item.items}}">é›¶ä»¶: {{item.items.length}}ä¸ª</text>
      </view>
    </view>

    <view class="empty-state" wx:if="{{rules.length === 0}}">
      <text>æš‚æ— {{ruleType === 'storage' ? 'å…¥åº“' : 'è£…é…'}}è§„åˆ™</text>
    </view>
  </scroll-view>

  <!-- åº•éƒ¨æŒ‰é’®ç»„ -->
  <view class="bottom-btns">
    <view class="reapply-btn" wx:if="{{ruleType === 'storage'}}" bindtap="reapplyRules">
      <text class="icon">ğŸ”„</text>
      <text>é‡æ–°åº”ç”¨è§„åˆ™</text>
    </view>
    <view class="add-btn" bindtap="addRule">+ æ·»åŠ è§„åˆ™</view>
  </view>

  <!-- ç¼–è¾‘å¼¹çª— - å…¥åº“è§„åˆ™ -->
  <view class="modal-mask" wx:if="{{showModal}}" bindtap="closeModal">
    <view class="modal-content" catchtap="preventClose">
      <view class="modal-header">
        <text class="modal-title">{{isEdit ? 'ç¼–è¾‘' : 'æ·»åŠ '}}{{ruleType === 'storage' ? 'å…¥åº“' : 'è£…é…'}}è§„åˆ™</text>
        <text class="modal-close" bindtap="closeModal">Ã—</text>
      </view>
      
      <!-- å…¥åº“è§„åˆ™è¡¨å• -->
      <scroll-view scroll-y class="modal-body" wx:if="{{ruleType === 'storage'}}">
        <view class="form-item">
          <text class="label">è§„åˆ™åç§°</text>
          <input class="input" placeholder="å¦‚ï¼šæˆªæ­¢é˜€å…¥åº“" value="{{formData.ruleName}}" bindinput="onInput" data-field="ruleName" />
        </view>
        <view class="form-item">
          <text class="label">äº§å“åŒ¹é…æ¨¡å¼</text>
          <input class="input" placeholder="å¦‚ï¼šæˆªæ­¢é˜€% æˆ– %é—¸é˜€%" value="{{formData.productPattern}}" bindinput="onInput" data-field="productPattern" />
          <text class="hint">ä½¿ç”¨ % ä½œä¸ºé€šé…ç¬¦</text>
        </view>
        <view class="form-item">
          <text class="label">å…¥åº“ç›®æ ‡</text>
          <input class="input" placeholder="å¦‚ï¼šæˆªæ­¢é˜€" value="{{formData.targetLocation}}" bindinput="onInput" data-field="targetLocation" />
        </view>
        <view class="form-item">
          <text class="label">å…¥åº“æ¯”ä¾‹</text>
          <picker class="picker" mode="selector" range="{{storageRatios}}" value="{{storageRatioIndex}}" bindchange="onRatioPicker">
            <view class="picker-view">{{formData.storageRatio || 'è¯·é€‰æ‹©å…¥åº“æ¯”ä¾‹'}}</view>
          </picker>
          <text class="hint">è®¾ç½®å…¥åº“æ—¶äº§å“ä¸åº“ä½çš„æ•°é‡æ¯”ä¾‹</text>
        </view>
        <view class="form-item">
          <text class="label">ä¼˜å…ˆçº§</text>
          <input class="input" type="number" placeholder="æ•°å€¼è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜" value="{{formData.priority}}" bindinput="onInput" data-field="priority" />
        </view>
        <view class="form-item">
          <text class="label">æ˜¯å¦æ¶ˆè€—æ¯›å¯</text>
          <switch checked="{{formData.isFinishedProduct}}" bindchange="onSwitchChange" data-field="isFinishedProduct" />
        </view>
        <view wx:if="{{formData.isFinishedProduct}}">
          <view class="form-item">
            <text class="label">æ¯›å¯äº§å“åç§°</text>
            <input class="input" placeholder="å¦‚ï¼šæˆªæ­¢é˜€ä½“" value="{{formData.blankProductName}}" bindinput="onInput" data-field="blankProductName" />
          </view>
          <view class="form-item">
            <text class="label">æ¯ä»¶æ¶ˆè€—æ¯›å¯æ•°</text>
            <input class="input" type="number" value="{{formData.blankQuantityPerUnit}}" bindinput="onInput" data-field="blankQuantityPerUnit" />
          </view>
        </view>
      </scroll-view>

      <!-- è£…é…è§„åˆ™è¡¨å• -->
      <scroll-view scroll-y class="modal-body" wx:if="{{ruleType === 'assembly'}}">
        <view class="form-item">
          <text class="label">äº§å“åç§°</text>
          <input class="input" placeholder="å¦‚ï¼šæˆªæ­¢é˜€" value="{{formData.productName}}" bindinput="onInput" data-field="productName" />
        </view>
        <view class="form-item">
          <text class="label">æ‰€éœ€é›¶ä»¶</text>
          <view class="parts-list">
            <view class="part-item" wx:for="{{formData.items}}" wx:key="index" wx:for-index="idx">
              <input class="part-name" placeholder="é›¶ä»¶åç§°" value="{{item.componentName}}" bindinput="onPartInput" data-idx="{{idx}}" data-field="componentName" />
              <input class="part-qty" type="number" placeholder="æ•°é‡" value="{{item.quantity}}" bindinput="onPartInput" data-idx="{{idx}}" data-field="quantity" />
              <text class="part-delete" bindtap="deletePart" data-idx="{{idx}}">Ã—</text>
            </view>
            <view class="add-part-btn" bindtap="addPart">+ æ·»åŠ é›¶ä»¶</view>
          </view>
        </view>
      </scroll-view>

      <view class="modal-footer">
        <button class="btn-cancel" bindtap="closeModal">å–æ¶ˆ</button>
        <button class="btn-delete" wx:if="{{isEdit}}" bindtap="deleteRule">åˆ é™¤</button>
        <button class="btn-save" bindtap="saveRule">ä¿å­˜</button>
      </view>
    </view>
  </view>
</view>

